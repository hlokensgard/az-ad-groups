# Azure AD group terraform module 
This module created an azure ad group with following access packages, conditional access policies and PIM. 

Based on Microsoft recommendation this module helps to ensure that users are assigned to the right access packages and conditional access policies.

## Microsoft security recommendation 
- [Access Packages](https://learn.microsoft.com/en-us/azure/active-directory/governance/entitlement-management-access-package-create)
- [Conditional Access](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/)
- [PIM](https://learn.microsoft.com/en-us/azure/active-directory/privileged-identity-management/concept-pim-for-groups)
- [Best Practices](https://learn.microsoft.com/en-us/azure/security/fundamentals/best-practices-and-patterns)


# Permissions 
The user or service principal that will deploy this code needs the following permissions: 
- Application Role:  
    - EntitlementManagement.ReadWrite.All
    - Policy.ReadAll
    - Policy.ReadWrite.ConditionalAccess
- Directory roles: 
    - Directory.ReadWrite.All
    - EntitlementManagement.ReadWrite.All
    - Policy.ReadAll
    - Policy.ReadWrite.ConditionalAccess

# Known Issues 
There is a known bug when deploying access packages using a client
- [GitHub Issue](https://github.com/hashicorp/terraform-provider-azuread/issues/1069)
Workaround is using a service principal with the following permissions: 
- AD Role : Identity Governance Administrator
- Graph API delegated permission : EntitlementManagement.ReadWrite.All 

Deleting the resources deployed by the module usually failed due to the following error: 
- `Deleting access package resource and catalog association with resource`
To fix this issue, delete the associated resources to the access package catalog in the portal. 

# Future plans
- Adding more logic to the module to support more scenarios
- Adding default values based on the best practices
- Adding the option for multiple blocks in resources that support it
    - Example: Multiple questions blocks in `azuread_access_package_assignment_policy`

# Autogenerated from pre-commit script for the ReadMe
<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | ~>1.0 |
| <a name="requirement_azuread"></a> [azuread](#requirement\_azuread) | ~>2.40 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | ~>3.65 |
| <a name="requirement_time"></a> [time](#requirement\_time) | ~>0.9 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azuread"></a> [azuread](#provider\_azuread) | 2.40.0 |
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | 3.65.0 |
| <a name="provider_time"></a> [time](#provider\_time) | 0.9.1 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [azuread_access_package.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/access_package) | resource |
| [azuread_access_package_assignment_policy.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/access_package_assignment_policy) | resource |
| [azuread_access_package_catalog.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/access_package_catalog) | resource |
| [azuread_access_package_resource_catalog_association.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/access_package_resource_catalog_association) | resource |
| [azuread_access_package_resource_package_association.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/access_package_resource_package_association) | resource |
| [azuread_conditional_access_policy.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/conditional_access_policy) | resource |
| [azuread_group.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/group) | resource |
| [azuread_group_member.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/group_member) | resource |
| [azurerm_pim_eligible_role_assignment.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/pim_eligible_role_assignment) | resource |
| [time_static.pim_start_time](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/static) | resource |
| [azuread_access_package.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/access_package) | data source |
| [azuread_access_package_catalog.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/access_package_catalog) | data source |
| [azuread_client_config.current](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/client_config) | data source |
| [azuread_user.members](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/user) | data source |
| [azurerm_role_definition.pim_role](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/role_definition) | data source |
| [azurerm_subscription.pim](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subscription) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_access_packages_configuration"></a> [access\_packages\_configuration](#input\_access\_packages\_configuration) | This variable is used to configure access packages for Azure AD group | <pre>object({<br>    create_new_package_catalog = optional(bool, false)<br>    access_package_catalog = optional(object({<br>      display_name       = string<br>      description        = optional(string, null) # This is only optional when create_new_package_catalog is set to false<br>      externally_visible = optional(bool, null)<br>      published          = optional(bool, null)<br>    }), null)<br>    create_new_access_package = optional(bool, false)<br>    existing_access_package_information = optional(object({<br>      catalog_id   = string<br>      display_name = string<br>    }), null)<br>    access_packages = object({<br>      display_name         = string<br>      description          = optional(string, null) # This is only optional when create_new_access_package is set to false<br>      hidden               = optional(bool, null)<br>      catalog_display_name = optional(string, null)<br>    })<br>    access_package_assignment_policy = object({<br>      approval_settings = optional(object({<br>        approval_required_for_extension = optional(bool, null)<br>        approval_required               = optional(bool, null)<br>        approval_stage = optional(object({<br>          alternative_approval_enabled = optional(bool, null)<br>          alternative_approver = optional(object({<br>            backup       = optional(bool, null)<br>            object_id    = optional(string, null)<br>            subject_type = string<br>          }), null)<br>          approval_timeout_in_days            = string<br>          approver_justification_required     = optional(bool, null)<br>          enable_alternative_approval_in_days = optional(string, null)<br>          primary_approver = optional(object({<br>            backup       = optional(bool, null)<br>            object_id    = optional(string, null)<br>            subject_type = string<br>          }), null)<br>        }), null)<br>        requestor_justification_required = optional(bool, null)<br>      }), null)<br>      assignment_review_settings = optional(object({<br>        access_recommendation_enabled   = optional(bool, null)<br>        access_review_timeout_behavior  = optional(string, null)<br>        approver_justification_required = optional(bool, null)<br>        duration_in_days                = number<br>        enabled                         = optional(bool, null)<br>        review_frequency                = optional(string, null)<br>        review_type                     = optional(string, null)<br>        reviewer = optional(object({<br>          backup       = optional(bool, null)<br>          object_id    = optional(string, null)<br>          subject_type = string<br>        }), null)<br>        starting_on = optional(string, null)<br>      }), null)<br>      description       = string<br>      display_name      = string<br>      duration_in_days  = optional(string, null)<br>      expiration_date   = optional(string, null)<br>      extension_enabled = optional(bool, null)<br>      question = optional(object({<br>        choice = optional(object({<br>          actual_value = string<br>          display_value = object({<br>            default_text = string<br>            localized_text = optional(object({<br>              content       = string<br>              language_code = string<br>            }), null)<br>          })<br>        }), null)<br>        required = optional(bool, null)<br>        sequence = optional(string, null)<br>        text = object({<br>          default_text = string<br>          localized_text = optional(object({<br>            content       = string<br>            language_code = string<br>          }), null)<br>        })<br>      }), null)<br>      requestor_settings = optional(object({<br>        requestor = optional(object({<br>          object_id    = optional(string, null)<br>          subject_type = string<br>        }), null)<br>        requests_accepted = optional(bool, null)<br>        scope_type        = optional(string, null)<br>      }), null)<br>    })<br>  })</pre> | `null` | no |
| <a name="input_azure_ad_group_configuration"></a> [azure\_ad\_group\_configuration](#input\_azure\_ad\_group\_configuration) | This variable is used to configure Azure AD group | <pre>object({<br>    administrative_unit_ids    = optional(set(string), null)<br>    assignable_to_role         = optional(bool, false)<br>    auto_subscribe_new_members = optional(bool, false)<br>    behaviors                  = optional(set(string), null)<br>    description                = optional(string, null)<br>    display_name               = string<br>    dynamic_membership = optional(object({<br>      enabled = bool<br>      rule    = string<br>    }), null)<br>    external_senders_allowed  = optional(bool, null)<br>    hide_from_address_lists   = optional(bool, null)<br>    hide_from_outlook_clients = optional(bool, null)<br>    mail_enabled              = optional(bool, null)<br>    mail_nickname             = optional(bool, null)<br>    members                   = optional(list(string), null)<br>    onpremises_group_type     = optional(string, "UniversalSecurityGroup")<br>    owners                    = optional(list(string), null)<br>    prevent_duplicate_names   = optional(bool, true)<br>    provisioning_options      = optional(set(string), null)<br>    security_enabled          = optional(bool, true)<br>    theme                     = optional(string, null)<br>    types                     = optional(list(string), null)<br>    visibility                = optional(string, null)<br>    writeback_enabled         = optional(string, false)<br>    access_package_id         = optional(string, null)<br>  })</pre> | n/a | yes |
| <a name="input_conditional_access_configuration"></a> [conditional\_access\_configuration](#input\_conditional\_access\_configuration) | This variable is used to configure conditional access for Azure AD group | <pre>object({<br>    display_name = string<br>    conditions = object({<br>      application = object({<br>        excluded_applications = optional(list(string), null)<br>        included_applications = optional(list(string), null)<br>        included_user_actions = optional(list(string), null)<br>      })<br>      client_app_types = list(string)<br>      users = object({<br>        excluded_groups = optional(list(string), null)<br>        excluded_roles  = optional(list(string), null)<br>        excluded_users  = optional(list(string), null)<br>        included_groups = optional(list(string), null)<br>        included_roles  = optional(list(string), null)<br>        included_users  = optional(list(string), null)<br>      })<br>      client_applications = optional(object({<br>        excluded_service_principals = optional(list(string), null)<br>        included_service_principals = optional(list(string), null)<br>      }), null)<br>      devices = optional(object({<br>        filter = optional(object({<br>          mode = string<br>          rule = string<br>        }), null)<br>      }), null)<br>      locations = optional(object({<br>        excluded_locations = optional(list(string), null)<br>        included_locations = list(string)<br>      }), null)<br>      platforms = optional(object({<br>        excluded_platforms = optional(list(string), null)<br>        included_platforms = optional(list(string), null)<br>      }), null)<br>      sign_in_risk_levels = optional(list(string), null)<br>      user_risk_levels    = optional(list(string), null)<br>    })<br>    session_controls = optional(object({<br>      application_enforced_restrictions_enabled = optional(bool, null)<br>      cloud_app_security_enabled                = optional(bool, null)<br>      disable_resilience_defaults               = optional(bool, null)<br>      persistent_browser_mode                   = optional(string, null)<br>      sign_in_frequency                         = optional(string, null)<br>      sign_in_frequency_period                  = optional(string, null)<br>    }), null)<br>    state = string<br>    grant_controls = object({<br>      built_in_controls             = list(string)<br>      custom_authentication_factors = optional(list(string), null)<br>      operator                      = string<br>      terms_of_use                  = optional(list(string), null)<br>    })<br>  })</pre> | `null` | no |
| <a name="input_enable_access_package"></a> [enable\_access\_package](#input\_enable\_access\_package) | This variable is used to enable access packages for Azure AD group | `bool` | `false` | no |
| <a name="input_enable_conditional_access"></a> [enable\_conditional\_access](#input\_enable\_conditional\_access) | This variable is used to enable conditional access for Azure AD group | `bool` | `false` | no |
| <a name="input_enable_pim"></a> [enable\_pim](#input\_enable\_pim) | This variable is used to enable pim for Azure AD group | `bool` | `false` | no |
| <a name="input_pim_configuration"></a> [pim\_configuration](#input\_pim\_configuration) | This variable is used to configure pim for Azure AD group | <pre>object({<br>    subscription_id              = string<br>    role_definition_display_name = string<br>    schedule = optional(object({<br>      expiration = optional(object({<br>        duration_days  = optional(string, null)<br>        duration_hours = optional(string, null)<br>        end_date_time  = optional(string, null)<br>      }), null)<br>      start_date_time = optional(string, null)<br>    }), null)<br>  })</pre> | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_azuread_group"></a> [azuread\_group](#output\_azuread\_group) | n/a |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->